<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerenciamento de Usuários</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    h1, h2 {
      margin: 0 0 8px;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .card {
      background: #1f2937;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }
    label {
      display: block;
      margin-top: 10px;
      margin-bottom: 4px;
      font-size: 14px;
    }
    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #f9fafb;
      box-sizing: border-box;
    }
    input:focus, select:focus {
      outline: none;
      border-color: #3b82f6;
    }
    button {
      margin-top: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      background: #3b82f6;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      background: #2563eb;
    }
    .mensagem {
      margin-top: 8px;
      font-size: 14px;
      min-height: 18px;
    }
    .mensagem.erro { color: #fca5a5; }
    .mensagem.sucesso { color: #6ee7b7; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      font-size: 14px;
    }
    th, td {
      padding: 8px;
      border-bottom: 1px solid #374151;
      text-align: left;
    }
    th {
      background: #111827;
    }
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      background: #4b5563;
    }
    .badge.admin { background: #f97316; }
    .badge.normal { background: #22c55e; }
    .btn-danger {
      background: #ef4444;
    }
    .btn-danger:hover {
      background: #b91c1c;
    }
    .status-login {
      margin-top: 8px;
      font-size: 14px;
      min-height: 18px;
    }
  </style>
</head>
<body>
  <h1>CRUD de Usuários + Login</h1>

  <div class="grid">
    <!-- Card de cadastro -->
    <div class="card">
      <h2>Cadastrar Usuário</h2>
      <form id="form-cadastro">
        <label for="nome">Nome</label>
        <input type="text" id="nome" required />

        <label for="emailCadastro">E-mail</label>
        <input type="email" id="emailCadastro" required />

        <label for="senhaCadastro">Senha</label>
        <input type="password" id="senhaCadastro" required />

        <label for="tipo_user">Tipo de Usuário</label>
        <select id="tipo_user">
          <option value="cliente">Normal</option>
          <option value="admin">Admin</option>
        </select>

        <label for="data_nascimento">Data de Nascimento</label>
        <input type="date" id="data_nascimento" />

        <button type="submit">Cadastrar</button>
      </form>
      <div id="msgCadastro" class="mensagem"></div>
    </div>

    <!-- Card de login -->
    <div class="card">
      <h2>Login</h2>
      <form id="form-login">
        <label for="emailLogin">E-mail</label>
        <input type="email" id="emailLogin" required />

        <label for="senhaLogin">Senha</label>
        <input type="password" id="senhaLogin" required />

        <button type="submit">Entrar</button>
      </form>
      <div id="msgLogin" class="status-login"></div>
    </div>
  </div>

  <!-- Card de listagem -->
  <div class="card">
    <h2>Lista de Usuários</h2>
    <button id="btnAtualizar">Atualizar lista</button>
    <table>
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome</th>
          <th>E-mail</th>
          <th>Tipo</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="tabela-usuarios">
        <!-- preenchido via JS -->
      </tbody>
    </table>
  </div>

  <script>
    const API_URL = "http://localhost:3000"; // backend

    const formCadastro = document.getElementById("form-cadastro");
    const formLogin = document.getElementById("form-login");
    const msgCadastro = document.getElementById("msgCadastro");
    const msgLogin = document.getElementById("msgLogin");
    const tabelaUsuarios = document.getElementById("tabela-usuarios");
    const btnAtualizar = document.getElementById("btnAtualizar");

    // 1) Cadastrar usuário (POST /api/users)
    formCadastro.addEventListener("submit", async (e) => {
      e.preventDefault();
      msgCadastro.textContent = "";
      msgCadastro.className = "mensagem";

      const nome = document.getElementById("nome").value.trim();
      const email = document.getElementById("emailCadastro").value.trim();
      const senha = document.getElementById("senhaCadastro").value.trim();
      const tipo_user = document.getElementById("tipo_user").value;
      const data_nascimento = document.getElementById("data_nascimento").value || null;

      if (!nome || !email || !senha) {
        msgCadastro.textContent = "Preencha nome, e-mail e senha.";
        msgCadastro.classList.add("erro");
        return;
      }

      try {
        const resposta = await fetch(`${API_URL}/api/users`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            nome,
            email,
            senha,
            tipo_user,
            data_nascimento
          }),
        });

        const data = await resposta.json();

        if (!resposta.ok) {
          msgCadastro.textContent = data.error || "Erro ao cadastrar usuário.";
          msgCadastro.classList.add("erro");
          return;
        }

        msgCadastro.textContent = "Usuário cadastrado com sucesso!";
        msgCadastro.classList.add("sucesso");
        formCadastro.reset();
        carregarUsuarios();
      } catch (erro) {
        console.error(erro);
        msgCadastro.textContent = "Erro ao conectar com o servidor.";
        msgCadastro.classList.add("erro");
      }
    });

    // 2) Login (POST /api/users/login)
    formLogin.addEventListener("submit", async (e) => {
      e.preventDefault();
      msgLogin.textContent = "";
      msgLogin.className = "status-login";

      const email = document.getElementById("emailLogin").value.trim();
      const senha = document.getElementById("senhaLogin").value.trim();

      if (!email || !senha) {
        msgLogin.textContent = "Preencha e-mail e senha.";
        return;
      }

      try {
        const resposta = await fetch(`${API_URL}/api/users/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, senha }),
        });

        const data = await resposta.json();

        if (!resposta.ok) {
          msgLogin.textContent = data.error || "Falha ao fazer login.";
          return;
        }

        // salva no localStorage
        localStorage.setItem("usuarioLogado", JSON.stringify(data.user));

        if (data.user.tipo_user === "admin") {
          msgLogin.textContent = `Admin logado: ${data.user.nome}`;
        } else {
          msgLogin.textContent = `Usuário normal logado: ${data.user.nome}`;
        }
      } catch (erro) {
        console.error(erro);
        msgLogin.textContent = "Erro ao conectar com o servidor.";
      }
    });

    // 3) Carregar usuários (GET /api/users)
    async function carregarUsuarios() {
      tabelaUsuarios.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";

      try {
        const resposta = await fetch(`${API_URL}/api/users`);
        const data = await resposta.json();

        if (!resposta.ok) {
          tabelaUsuarios.innerHTML = `<tr><td colspan="5">Erro: ${data.error}</td></tr>`;
          return;
        }

        if (!Array.isArray(data) || data.length === 0) {
          tabelaUsuarios.innerHTML = "<tr><td colspan='5'>Nenhum usuário cadastrado.</td></tr>";
          return;
        }

        tabelaUsuarios.innerHTML = "";
        data.forEach((user) => {
          const tr = document.createElement("tr");

          const tipoBadgeClass =
            user.tipo_user === "admin" ? "badge admin" : "badge normal";
          const tipoTexto =
            user.tipo_user === "admin" ? "Admin" : "Normal";

          tr.innerHTML = `
            <td>${user.id_user ?? user.id ?? ""}</td>
            <td>${user.nome}</td>
            <td>${user.email}</td>
            <td><span class="${tipoBadgeClass}">${tipoTexto}</span></td>
            <td>
              <button class="btn-danger" data-id="${user.id_user ?? user.id ?? ""}">
                Excluir
              </button>
            </td>
          `;

          tabelaUsuarios.appendChild(tr);
        });

        // Adiciona evento aos botões de excluir (se sua API tiver DELETE)
        document.querySelectorAll(".btn-danger").forEach((btn) => {
          btn.addEventListener("click", () => {
            const id = btn.getAttribute("data-id");
            if (id) {
              excluirUsuario(id);
            }
          });
        });
      } catch (erro) {
        console.error(erro);
        tabelaUsuarios.innerHTML = "<tr><td colspan='5'>Erro ao carregar usuários.</td></tr>";
      }
    }

    // 4) Excluir usuário (DELETE /api/users/:id) - precisa existir no backend
    async function excluirUsuario(id) {
      const confirmar = confirm("Tem certeza que deseja excluir este usuário?");
      if (!confirmar) return;

      try {
        const resposta = await fetch(`${API_URL}/api/users/${id}`, {
          method: "DELETE",
        });
        const data = await resposta.json();

        if (!resposta.ok) {
          alert(data.error || "Erro ao excluir usuário.");
          return;
        }

        alert("Usuário excluído com sucesso!");
        carregarUsuarios();
      } catch (erro) {
        console.error(erro);
        alert("Erro ao conectar com o servidor.");
      }
    }

    // botão "Atualizar lista"
    btnAtualizar.addEventListener("click", carregarUsuarios);

    // carrega a lista ao abrir a página
    carregarUsuarios();
  </script>
</body>
</html>
